#!/usr/bin/env python3
import gi, subprocess, os, sys, signal, json, argparse
gi.require_version("Gtk", "3.0")
gi.require_version("GtkLayerShell", "0.1")
from gi.repository import Gtk, GtkLayerShell, Gdk

PIDFILE = "/tmp/waybar_volume_slider.pid"

def get_volume(sink=True):
    cmd = ["pactl", "get-sink-volume" if sink else "get-source-volume",
           "@DEFAULT_SINK@" if sink else "@DEFAULT_SOURCE@"]
    out = subprocess.check_output(cmd, text=True)
    return int(out.split("/")[1].strip().replace("%", ""))

def set_volume(vol, sink=True):
    cmd = ["pactl", "set-sink-volume" if sink else "set-source-volume",
           "@DEFAULT_SINK@" if sink else "@DEFAULT_SOURCE@", f"{vol}%"]
    subprocess.run(cmd)

def get_waybar_rect():
    layers_data = json.loads(subprocess.check_output(["hyprctl", "layers", "-j"], text=True))

    if isinstance(layers_data, dict):
        monitors = layers_data.values()
    else:
        monitors = layers_data

    for monitor in monitors:
        if not isinstance(monitor, dict):
            continue
        layer_dict = monitor.get("levels") or monitor.get("layers")
        if not layer_dict:
            continue
        for layer in layer_dict.values():
            for surf in layer:
                if surf.get("namespace") == "waybar":
                    return (surf["x"], surf["y"]), (surf["w"], surf["h"])
    return None, None

class VolumeMicSliders(Gtk.Window):
    def __init__(self, bar_pos, bar_size, icon_xpos=None):
        Gtk.Window.__init__(self, type=Gtk.WindowType.TOPLEVEL)

        # Load CSS after window creation
        css_provider = Gtk.CssProvider()
        css_path = os.path.expanduser("~/.config/waybar/styles/volume-slider.css")
        css_provider.load_from_path(css_path)
        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            css_provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION
        )

        GtkLayerShell.init_for_window(self)
        GtkLayerShell.set_layer(self, GtkLayerShell.Layer.OVERLAY)
        GtkLayerShell.set_keyboard_interactivity(self, False)

        GtkLayerShell.set_anchor(self, GtkLayerShell.Edge.TOP, True)
        GtkLayerShell.set_anchor(self, GtkLayerShell.Edge.LEFT, True)

        # Vertical position: right under bar
        GtkLayerShell.set_margin(self, GtkLayerShell.Edge.TOP, bar_pos[1] + bar_size[1])

        # Horizontal position: either passed from Waybar or default
        xpos = icon_xpos if icon_xpos is not None else bar_pos[0]
        slider_width = 70  # your slider's total width in pixels
        GtkLayerShell.set_margin(self, GtkLayerShell.Edge.LEFT, int(xpos - slider_width / 2))


        box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)

        vol_adj = Gtk.Adjustment(value=get_volume(True), lower=0, upper=100, step_increment=1)
        vol_slider = Gtk.Scale(orientation=Gtk.Orientation.VERTICAL, adjustment=vol_adj)
        vol_slider.set_draw_value(False)
        vol_slider.set_size_request(30, 150)
        vol_slider.connect("value-changed", lambda s: set_volume(int(s.get_value()), True))

        mic_adj = Gtk.Adjustment(value=get_volume(False), lower=0, upper=100, step_increment=1)
        mic_slider = Gtk.Scale(orientation=Gtk.Orientation.VERTICAL, adjustment=mic_adj)
        mic_slider.set_draw_value(False)
        mic_slider.set_size_request(30, 150)
        mic_slider.connect("value-changed", lambda s: set_volume(int(s.get_value()), False))

        vol_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=3)
        vol_box.pack_start(vol_slider, True, True, 0)
        vol_box.pack_start(Gtk.Label(label="ðŸ”Š"), False, False, 0)

        mic_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=3)
        mic_box.pack_start(mic_slider, True, True, 0)
        mic_box.pack_start(Gtk.Label(label="ðŸŽ¤"), False, False, 0)

        box.pack_start(vol_box, True, True, 0)
        box.pack_start(mic_box, True, True, 0)

        self.add(box)
        self.show_all()

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--xpos", type=int, help="X coordinate of the icon from Waybar")
    args = parser.parse_args()

    if os.path.exists(PIDFILE):
        with open(PIDFILE) as f:
            pid = int(f.read().strip())
            try:
                os.kill(pid, signal.SIGTERM)
            except ProcessLookupError:
                pass
        os.remove(PIDFILE)
        sys.exit(0)

    bar_pos, bar_size = get_waybar_rect()
    if not bar_pos:
        print("Waybar layer not found via hyprctl")
        sys.exit(1)

    with open(PIDFILE, "w") as f:
        f.write(str(os.getpid()))

    win = VolumeMicSliders(bar_pos, bar_size, icon_xpos=args.xpos)
    win.connect("destroy", Gtk.main_quit)
    Gtk.main()

    if os.path.exists(PIDFILE):
        os.remove(PIDFILE)
